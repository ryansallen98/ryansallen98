---
import meta from "@data/general/meta.yml";
import socials from "@data/general/socials.yml";

const {
  title,
  description,
  image,
  noIndex = false,
  noBrand = false,
  locale = "en-GB",

  isArticle = false,
  datePublished, // for articles
  dateModified, // for articles
} = Astro.props;

const ogLocale = locale.replace("-", "_");

const siteName = meta.siteName;
const brand = meta.brand;
const tagline = meta.tagline;

const pageTitle = noBrand
  ? title
  : title
    ? `${title} | ${siteName} (${brand})`
    : `${siteName} (${brand}) | ${tagline}`;
const pageDescription = description ? description : meta.description;
const pageImage = image ? image : meta.image;

const sameAs =
  socials?.profiles?.map((profile: { url: string }) => profile.url) ?? [];

const baseUrl = import.meta.env.SITE_URL ?? "http://localhost:3000";

const entitySchema = {
  "@context": "https://schema.org",
  "@type": meta.entityType, // Organization, Person etc.
  "@id": `${baseUrl}#identity`,

  name: siteName,
  legalName: meta.legalName ?? siteName,
  description: meta.description,
  url: baseUrl,
  ...(meta.logo && {
    logo: {
      "@type": "ImageObject",
      url: meta.logo,
    },
  }),
  sameAs,
  ...(meta.entityType === "Person" &&
    meta.jobTitle && {
      jobTitle: meta.jobTitle,
    }),
};

const websiteSchema: WebsiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: siteName,
  url: baseUrl,
  description: meta.description,
  inLanguage: locale,
  publisher: {
    "@id": `${baseUrl}#identity`,
  },
};

if (meta.hasSearch) {
  websiteSchema.potentialAction = {
    "@type": "SearchAction",
    target: `${baseUrl}/search?q={search_term_string}`,
    "query-input": "required name=search_term_string",
  };
}

const schemaGraph = {
  "@context": "https://schema.org",
  "@graph": [entitySchema, websiteSchema],
};

const articleSchema = {
  "@type": "BlogPosting",
  "@id": `${Astro.url.href}#article`,
  headline: pageTitle,
  description: pageDescription,
  url: Astro.url.href,
  inLanguage: locale,

  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": Astro.url.href,
  },

  author: {
    "@id": `${baseUrl}#identity`,
  },

  publisher: {
    "@id": `${baseUrl}#identity`,
  },

  ...(pageImage && {
    image: [
      {
        "@type": "ImageObject",
        url: pageImage,
      },
    ],
  }),

  ...(datePublished && { datePublished }),
  ...(dateModified && { dateModified }),
};

if (isArticle) {
  schemaGraph["@graph"].push(articleSchema);
}
---

<meta charset="UTF-8" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="generator" content={Astro.generator} />
<title>{pageTitle}</title>
<meta name="description" content={pageDescription} />
<link rel="canonical" href={Astro.url.href} />
<meta property="og:type" content={isArticle ? "article" : "website"} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:site_name" content={siteName} />
<meta property="og:url" content={Astro.url.href} />
<meta property="og:locale" content={ogLocale} />
{
  pageImage && (
    <>
      <meta property="og:image" content={pageImage} />
      <meta property="og:image:alt" content={pageTitle} />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
    </>
  )
}
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />
{
  pageImage && (
    <>
      <meta name="twitter:image" content={pageImage} />
      <meta name="twitter:image:alt" content={pageTitle} />
    </>
  )
}
<meta
  name="robots"
  content={noIndex
    ? "noindex, nofollow"
    : "index, follow, max-image-preview:large"}
/>
<meta name="referrer" content="strict-origin-when-cross-origin" />
{meta.themeColor && <meta name="theme-color" content={meta.themeColor} />}
<script type="application/ld+json" set:html={JSON.stringify(schemaGraph)} />
